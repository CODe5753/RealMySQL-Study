# 10.1 통계 정보

- 8.0부터 인덱스되지 않은 컬럼들에 대해서도 데이터 분포도를 수집해서 저장하는 히스토그램 정보가 도입

## 10.1.1 테이블 및 인덱스 통계 정보

- 비용 기반 최적화에서 가장 중요한 것은 통계 정보
- 1억 건의 레코드가 저장된 테이블의 통계 정보가 갱신되지 않아서 레코드가 10건 미만인 것처럼 돼 있다면 옵티마이저는 인덱스 레인지 스캔이 아니라 풀 테이블 스캔을 할 것임


### 10.1.1.1 MySQL 서버의 통계 정보

- 5.6버전부터 InnoDB 스토리지 엔진을 사용하는 테이블에 대한 통계 정보를 영구적으로(Persistent) 관리할 수 있게 개선됐음
- 5.5까지는 메모리에만 관리되고 `SHOW INDEX` 명령으로만 테이블의 인덱스 컬럼의 분포도를 볼 수 있었다
- 메모리에 관리된다는 것은 **서버가 재시작되면 모조리 사라진다는 뜻**임
- 5.6부터 통계 정보를 innodb_index_stats, innodb_table_stats 테이블로 관리할 수 있게 개선됨

```mysql
SHOW TABLES LIKE '%_stats';
```

- 테이블 생성 시 STATS_PERSISTENT를 0으로 하면 5.5 이전 방식대로 관리
- 1로 하면 테이블에 저장
- default로 하면 innodb_stats_persistent 시스템 변수 값 따라감
- 해당 변수는 default가 1(ON)임
- 아래와 같은 이벤트 발생 시 자동으로 통계 정보가 갱신됨
  - 테이블이 새로 오픈되는 경우
  - 레코드가 대량으로 변경되는 경우(1/16 이상 update, insert, delete)
  - analyze table 명령 실행 시
  - show table status, show index from이 실행되는 경우
  - InnoDB 모니터가 활성화 되는 경우
  - innodb_stats_on_metadata 시스템 설정이 ON인 상태에서 SHOW TABLE STATUS 명령이 실행되는 경우


- 이처럼 통계 정보 자동 수집도 `STATS_AUTO_RECALC` 옵션으로 조절 가능함
  - 1: 5.5 이전 방식대로 자동 수집
  - 0: ANALYZE TABLE 명령 실행할 때만 수집
  - DEFAULT: 별도로 이 옵션을 설정하지 않은 것과 동일. innodb_stats_auto_recalc 변수 값으로 결정함

- 몇 개의 InnoDB 테이블 블록을 샘플링할지 결정하는 옵션인 innodb_stats_sample_pages가 있음
  - 5.6부터 없어짐 대신 innodb_stats_transient_sample_pages와 innodb_stats_persistent_sample_pages 시스템 변수 2개로 분리 됐음
  - innodb_stats_transient_sample_pages 기본값 8. 8개 페이지만 임의로 샘플링해서 분석한다는 뜻
  - innodb_stats_persistent_sample_pages
    - default 20이고 ANALYZE TABLE 명령 실행 시 20개 페이지를 샘플링하고 영구적인 테이블에 저장한다는 뜻

## 10.1.2 히스토그램

- 5.7까지의 통계 정보는 단순히 인덱스된 컬럼의 유니크한 값의 개수 정도만 가지고 있었어서 실행 계획을 수립하기엔 많이 부족했음
- 8.0부터 컬럼의 데이터 분포도를 참조할 수 있는 히스토그램 정보를 활용할 수 있게 됐음

### 10.1.2.1 히스토그램 정보 수집 및 삭제

